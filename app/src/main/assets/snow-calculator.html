<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Snow Day Calculator</title>
    <!-- Material Design Web Components -->
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css">
    <!-- Material Symbols (Variable Font) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Google Fonts - Roboto for Material Design -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        /*----------------------------------------------------
          CSS Variables for Dynamic Theming
        ----------------------------------------------------*/
        :root {
          /* Simplified Light Theme Variables */
          --md-sys-color-primary: #8b5000;
          --md-sys-color-on-primary: #ffffff;
          --md-sys-color-primary-container: #ffdcb9;
          --md-sys-color-on-primary-container: #2b1700;

          /* Reduce unique colors by reusing colors */
          --md-sys-color-secondary: #8b5000; /* Same as primary */
          --md-sys-color-on-secondary: #ffffff; /* Same as on-primary */
          --md-sys-color-secondary-container: #ffdcb9; /* Same as primary-container */
          --md-sys-color-on-secondary-container: #2b1700; /* Same as on-primary-container */

          --md-sys-color-tertiary: #5d6237;
          --md-sys-color-on-tertiary: #ffffff;
          --md-sys-color-tertiary-container: #e1e7b1;
          --md-sys-color-on-tertiary-container: #1a1d00;

          --md-sys-color-error: #ba1a1a;
          --md-sys-color-on-error: #ffffff;
          --md-sys-color-error-container: #ffdad6;
          --md-sys-color-on-error-container: #410002;

          --md-sys-color-background: #fffbff;
          --md-sys-color-on-background: #1f1b16;
          --md-sys-color-surface: #fffbff;
          --md-sys-color-on-surface: #1f1b16;
          --md-sys-color-surface-container: #ffffff;
          --md-sys-color-on-surface-container: #1f1b16; /* Same as on-background */
          --md-sys-color-surface-variant: #f0e0d0;
          --md-sys-color-on-surface-variant: #1f1b16; /* Same as on-background */

          --md-sys-color-outline: #827568;
          --md-sys-color-outline-variant: #d3c4b5;
          --md-sys-color-shadow: rgba(0, 0, 0, 0.1);
          --md-sys-elevation-1: 0 1px 2px 0 rgba(0, 0, 0, 0.1), 0 1px 3px 1px rgba(0, 0, 0, 0.08);
          --md-sys-elevation-2: 0 2px 4px 0 rgba(0, 0, 0, 0.1), 0 3px 5px 2px rgba(0, 0, 0, 0.08);
          --md-sys-elevation-3: 0 4px 8px 3px rgba(0, 0, 0, 0.1), 0 1px 10px 0 rgba(0, 0, 0, 0.08);

          /* Status Bar Background */
          --md-sys-color-status-bar: rgba(255, 251, 255, 0.95);

          /* Original color scheme (for when Material Theming is off) */
          --original-primary: #da7c5d;
          --original-primary-variant: #c06548;
          --original-background: #f0efe7;
          --original-surface: #ffffff;
          --original-on-primary: #ffffff;
          --original-on-background: #3d3929;
          --original-on-surface: #3d3929;
          --original-on-surface-variant: #98958e;
        }

        [data-theme="dark"] {
          /* Simplified Dark Theme Variables */
          --md-sys-color-primary: #ffb86b;
          --md-sys-color-on-primary: #492900;
          --md-sys-color-primary-container: #673d00;
          --md-sys-color-on-primary-container: #ffdcb9;

          /* Reduce unique colors by reusing colors */
          --md-sys-color-secondary: #ffb86b; /* Same as primary */
          --md-sys-color-on-secondary: #492900; /* Same as on-primary */
          --md-sys-color-secondary-container: #673d00; /* Same as primary-container */
          --md-sys-color-on-secondary-container: #ffdcb9; /* Same as on-primary-container */

          --md-sys-color-tertiary: #c5cb97;
          --md-sys-color-on-tertiary: #303410;
          --md-sys-color-tertiary-container: #464a23;
          --md-sys-color-on-tertiary-container: #e1e7b1;

          --md-sys-color-error: #ffb4ab;
          --md-sys-color-on-error: #690005;
          --md-sys-color-error-container: #93000a;
          --md-sys-color-on-error-container: #ffdad6;

          --md-sys-color-background: #1f1b16;
          --md-sys-color-on-background: #ebe1d9;
          --md-sys-color-surface: #1f1b16;
          --md-sys-color-on-surface: #ebe1d9;
          --md-sys-color-surface-container: #2e2922;
          --md-sys-color-on-surface-container: #ebe1d9; /* Same as on-background */
          --md-sys-color-surface-variant: #504539;
          --md-sys-color-on-surface-variant: #ebe1d9; /* Same as on-background */

          --md-sys-color-outline: #9c8a78;
          --md-sys-color-outline-variant: #504539;
          --md-sys-color-shadow: rgba(0, 0, 0, 0.3);
          --md-sys-color-status-bar: rgba(31, 27, 22, 0.95);

          /* Original dark color scheme */
          --original-primary: #da7c5d;
          --original-primary-variant: #c06548;
          --original-background: #272726;
          --original-surface: #3e3d3a;
          --original-on-primary: #ffffff;
          --original-on-background: #e2e2df;
          --original-on-surface: #e2e2df;
          --original-on-surface-variant: #98958e;
        }

        /* When Material Theming is off */
        [data-material-theming="off"] {
          --md-sys-color-primary: var(--original-primary);
          --md-sys-color-on-primary: var(--original-on-primary);
          --md-sys-color-primary-container: var(--original-primary-variant);
          --md-sys-color-on-primary-container: var(--original-on-primary);

          --md-sys-color-secondary: var(--original-primary);
          --md-sys-color-on-secondary: var(--original-on-primary);
          --md-sys-color-secondary-container: var(--original-primary-variant);
          --md-sys-color-on-secondary-container: var(--original-on-primary);

          --md-sys-color-tertiary: var(--original-primary);
          --md-sys-color-on-tertiary: var(--original-on-primary);
          --md-sys-color-tertiary-container: var(--original-primary-variant);
          --md-sys-color-on-tertiary-container: var(--original-on-primary);

          --md-sys-color-background: var(--original-background);
          --md-sys-color-on-background: var(--original-on-background);
          --md-sys-color-surface: var(--original-surface);
          --md-sys-color-on-surface: var(--original-on-surface);
          --md-sys-color-surface-container: var(--original-surface);
          --md-sys-color-on-surface-container: var(--original-on-surface);
          --md-sys-color-surface-variant: var(--original-surface);
          --md-sys-color-on-surface-variant: var(--original-on-surface-variant);
        }

        /*----------------------------------------------------
          Global Styles & Reset
        ----------------------------------------------------*/
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          -webkit-tap-highlight-color: transparent;
        }

        html {
          height: -webkit-fill-available;
        }

        body {
          min-height: 100vh;
          min-height: -webkit-fill-available;
          background-color: var(--md-sys-color-background);
          color: var(--md-sys-color-on-background);
          font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          transition: background-color 0.25s ease, color 0.25s ease;
          padding: 0;
          margin: 0;
          opacity: 0;
          animation: fadeIn 0.8s ease-out forwards 0.2s;
          overflow-x: hidden;
        }

        @keyframes fadeIn {
          to { opacity: 1; }
        }

        /*----------------------------------------------------
          Top App Bar
        ----------------------------------------------------*/
        .top-app-bar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 10;
          height: 64px;
          padding-top: env(safe-area-inset-top, 0);
          background-color: var(--md-sys-color-status-bar);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          box-shadow: var(--md-sys-elevation-1);
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.25s ease;
        }

        .app-title {
          font-size: 1.25rem;
          font-weight: 500;
          color: var(--md-sys-color-on-background);
          text-align: center;
        }

        /*----------------------------------------------------
          Container Layout
        ----------------------------------------------------*/
        .main-container {
          padding: calc(64px + env(safe-area-inset-top, 0) + 16px) 16px calc(16px + env(safe-area-inset-bottom, 0)) 16px;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
          width: 100%;
        }

        /*----------------------------------------------------
          Material Card Styling
        ----------------------------------------------------*/
        .md-card {
          width: 100%;
          max-width: 500px;
          background-color: var(--md-sys-color-surface-container);
          border-radius: 16px;
          box-shadow: var(--md-sys-elevation-1);
          margin-bottom: 16px;
          overflow: hidden;
          transform: translateY(20px);
          opacity: 0;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .md-card.show {
          transform: translateY(0);
          opacity: 1;
        }

        .md-card-header {
          padding: 16px 16px 8px 16px;
        }

        .md-card-title {
          font-size: 1.125rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface);
          margin-bottom: 4px;
        }

        .md-card-content {
          padding: 8px 16px 16px 16px;
        }

        /*----------------------------------------------------
          Date Display
        ----------------------------------------------------*/
        .date-display {
          background-color: var(--md-sys-color-surface-variant);
          border-radius: 20px;
          padding: 12px 20px;
          width: 100%;
          max-width: 300px;
          margin: 0 auto 16px;
          font-size: 0.95rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface-variant);
          box-shadow: var(--md-sys-elevation-1);
          text-align: center;
          transform: scale(0.95);
          opacity: 0;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .date-display.show {
          opacity: 1;
          transform: scale(1);
        }

        /*----------------------------------------------------
          Material Button
        ----------------------------------------------------*/
        .md-button {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          min-height: 40px;
          padding: 0 24px;
          border-radius: 20px;
          font-size: 0.875rem;
          font-weight: 500;
          letter-spacing: 0.1px;
          text-transform: capitalize;
          cursor: pointer;
          transition: all 0.2s ease;
          position: relative;
          overflow: hidden;
          border: none;
          -webkit-appearance: none;
          margin-bottom: 24px; /* Added more space between button and card */
        }

        .md-button-text {
          position: relative;
          z-index: 1;
        }

        .md-button::after {
          content: "";
          display: block;
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
          pointer-events: none;
          background-image: radial-gradient(circle, rgba(255, 255, 255, 0.4) 10%, transparent 10.01%);
          background-repeat: no-repeat;
          background-position: 50%;
          transform: scale(10, 10);
          opacity: 0;
          transition: transform 0.4s, opacity 0.8s;
        }

        .md-button:active::after {
          transform: scale(0, 0);
          opacity: 0.3;
          transition: 0s;
        }

        .md-button:active {
          transform: scale(0.98);
        }

        .md-button-filled {
          background-color: var(--md-sys-color-primary);
          color: var(--md-sys-color-on-primary);
          box-shadow: var(--md-sys-elevation-1);
        }

        .md-button-filled:active {
          box-shadow: var(--md-sys-elevation-1);
        }

        .md-button.analyzing {
          animation: pulse 1.5s infinite alternate;
          pointer-events: none;
        }

        @keyframes pulse {
          from { opacity: 1; transform: scale(1); }
          to { opacity: 0.9; transform: scale(0.99); }
        }

        /*----------------------------------------------------
          Weather Conditions Layout
        ----------------------------------------------------*/
        .conditions {
          display: flex;
          justify-content: space-around;
          align-items: stretch;
          gap: 8px;
          width: 100%;
        }

        .condition-group {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 16px 8px;
          min-height: 110px;
          background-color: var(--md-sys-color-surface-variant);
          border-radius: 16px;
          transition: transform 0.2s ease;
          position: relative;
          overflow: hidden;
        }

        .condition-group::after {
          content: "";
          display: block;
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
          pointer-events: none;
          background-image: radial-gradient(circle, rgba(var(--md-sys-color-primary-rgb), 0.1) 10%, transparent 10.01%);
          background-repeat: no-repeat;
          background-position: 50%;
          transform: scale(10, 10);
          opacity: 0;
          transition: transform 0.4s, opacity 0.8s;
        }

        .condition-group:active::after {
          transform: scale(0, 0);
          opacity: 0.6;
          transition: 0s;
        }

        .condition-group:active {
          transform: scale(0.98);
        }

        .material-symbols-rounded, .material-symbols-outlined {
          font-size: 24px;
          font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
          color: var(--md-sys-color-primary);
          margin-bottom: 8px;
        }

        .data-value {
          font-size: 1.25rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface-variant);
          margin-bottom: 4px;
        }

        .condition-label {
          font-size: 0.8rem;
          color: var(--md-sys-color-on-surface-variant);
          opacity: 0.8;
          text-align: center;
          width: 100%;
          line-height: 1.2;
        }

        /*----------------------------------------------------
          Prediction Gauge
        ----------------------------------------------------*/
        .gauge-container {
          width: 100%;
          margin-bottom: 20px;
        }

        .gauge {
          position: relative;
          width: 100%;
          height: 12px;
          background: var(--md-sys-color-surface-variant);
          border-radius: 6px;
          overflow: hidden;
          margin-bottom: 16px;
          box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .gauge-fill {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 0;
          background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
          border-radius: 6px;
          transition: width 2.2s cubic-bezier(0.34, 1.56, 0.64, 1);
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .gauge-value {
          font-size: 3rem;
          font-weight: 300;
          color: var(--md-sys-color-on-surface);
          text-align: center;
          margin-top: 8px;
          margin-bottom: 16px;
        }

        .prediction-result {
          padding: 16px;
          background-color: var(--md-sys-color-surface-variant);
          border-radius: 16px;
          text-align: center;
        }

        .prediction-header {
          font-size: 1rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface-variant);
          margin-bottom: 8px;
        }

        .prediction-header strong {
          font-weight: 700;
        }

        .prediction-description {
          font-size: 0.9rem;
          color: var(--md-sys-color-on-surface-variant);
          opacity: 0.9;
          line-height: 1.4;
        }

        /*----------------------------------------------------
          Bottom Section
        ----------------------------------------------------*/
        .bottom-section {
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-top: auto;
          padding-top: 24px;
          margin-bottom: calc(80px + env(safe-area-inset-bottom, 0));
          opacity: 0;
          animation: fadeIn 1s ease-out forwards 1s;
        }

        .avatar {
          width: 64px;
          height: 64px;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 12px;
          border: 2px solid var(--md-sys-color-primary);
          box-shadow: var(--md-sys-elevation-1);
        }

        .footer-message {
          font-size: 0.9rem;
          color: var(--md-sys-color-on-background);
          font-style: italic;
          margin-bottom: 20px;
          text-align: center;
        }

        .footer-info {
          font-size: 0.8rem;
          color: var(--md-sys-color-on-surface-variant);
          text-align: center;
          margin-bottom: 16px;
          line-height: 1.5;
        }

        /*----------------------------------------------------
          Settings FAB
        ----------------------------------------------------*/
        .fab {
          position: fixed;
          right: 16px;
          bottom: calc(16px + env(safe-area-inset-bottom, 0));
          width: 56px;
          height: 56px;
          border-radius: 28px;
          background-color: var(--md-sys-color-primary-container);
          color: var(--md-sys-color-on-primary-container);
          box-shadow: var(--md-sys-elevation-2);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s ease;
          z-index: 100;
          border: none;
          outline: none;
          -webkit-tap-highlight-color: transparent;
        }

        .fab:active {
          transform: scale(0.95);
          box-shadow: var(--md-sys-elevation-1);
        }

        .fab::after {
          display: none; /* Remove the ripple effect circle */
        }

        .fab .material-symbols-rounded {
          color: var(--md-sys-color-on-primary-container);
          margin-bottom: 0;
        }

        /*----------------------------------------------------
          Bottom Sheet
        ----------------------------------------------------*/
        .sheet-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.3);
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }

        .sheet-overlay.active {
          opacity: 1;
          pointer-events: all;
        }

        .bottom-sheet {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: var(--md-sys-color-surface);
          border-radius: 28px 28px 0 0;
          box-shadow: var(--md-sys-elevation-3);
          padding: 24px 16px max(24px, env(safe-area-inset-bottom, 0)) 16px;
          z-index: 2000;
          transform: translateY(100%);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bottom-sheet.active {
          transform: translateY(0);
        }

        /* Pull indicator */
        .bottom-sheet::before {
          content: '';
          position: absolute;
          top: 8px;
          left: 50%;
          transform: translateX(-50%);
          width: 32px;
          height: 4px;
          background-color: var(--md-sys-color-outline);
          opacity: 0.4;
          border-radius: 2px;
        }

        .sheet-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px 8px;
          margin-bottom: 8px;
        }

        .sheet-title {
          font-size: 1.25rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface);
        }

        .close-button {
          color: var(--md-sys-color-primary);
          background: none;
          border: none;
          font-size: 0.95rem;
          font-weight: 500;
          cursor: pointer;
          padding: 8px 12px;
          border-radius: 4px;
        }

        .settings-section {
          margin-bottom: 24px;
        }

        .settings-section-header {
          text-transform: uppercase;
          font-size: 0.75rem;
          font-weight: 500;
          color: var(--md-sys-color-on-surface-variant);
          margin-bottom: 8px;
          padding: 0 8px;
          letter-spacing: 0.5px;
        }

        .settings-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px;
          background-color: var(--md-sys-color-surface-variant);
          border-radius: 16px;
          margin-bottom: 8px;
          position: relative;
          overflow: hidden;
          cursor: pointer;
        }

        .settings-item-title {
          font-size: 0.95rem;
          font-weight: 400;
          color: var(--md-sys-color-on-surface-variant);
        }

        .settings-item-right {
          display: flex;
          align-items: center;
        }

        .settings-version {
          font-size: 0.95rem;
          font-weight: 400;
          color: var(--md-sys-color-on-surface-variant);
          opacity: 0.7;
        }

        .settings-bundle {
          font-size: 0.875rem;
          font-weight: 400;
          color: var(--md-sys-color-on-surface-variant);
          opacity: 0.7;
        }

        /*----------------------------------------------------
          Switch
        ----------------------------------------------------*/
        .md-switch {
          position: relative;
          display: inline-block;
          width: 52px;
          height: 32px;
        }

        .md-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .switch-track {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: var(--md-sys-color-outline);
          transition: .3s;
          border-radius: 16px;
        }

        .switch-track:before {
          position: absolute;
          content: "";
          height: 24px;
          width: 24px;
          left: 4px;
          bottom: 4px;
          background-color: var(--md-sys-color-surface);
          transition: .3s;
          border-radius: 50%;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input:checked + .switch-track {
          background-color: var(--md-sys-color-primary);
        }

        input:checked + .switch-track:before {
          transform: translateX(20px);
        }

        /*----------------------------------------------------
          Share Button
        ----------------------------------------------------*/
        .share-button {
          color: var(--md-sys-color-primary);
          background: none;
          border: none;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          width: 15px;
          height: 15px;
          border-radius: 20px;
        }

        .share-button .material-symbols-rounded {
          font-size: 15px;
        }

        /*----------------------------------------------------
          Snowflakes Animation
        ----------------------------------------------------*/
        .snowflakes {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: -1;
          overflow: hidden;
        }

        .snowflake {
          position: absolute;
          width: 4px;
          height: 4px;
          background-color: var(--md-sys-color-on-background);
          opacity: 0.1;
          border-radius: 50%;
          animation: snowfall linear infinite;
        }

        [data-theme="dark"] .snowflake {
          opacity: 0.15;
        }

        @keyframes snowfall {
          0% { transform: translateY(-5vh) rotate(0deg); opacity: 0; }
          20% { opacity: 0.1; }
          100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
        }

        /*----------------------------------------------------
          Loading Spinner
        ----------------------------------------------------*/
        .loading-spinner {
          display: inline-block;
          width: 18px;
          height: 18px;
          border: 2px solid rgba(255,255,255,0.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        /*----------------------------------------------------
          Responsive Adjustments
        ----------------------------------------------------*/
        @media (min-width: 500px) {
          .main-container {
            padding-top: calc(80px + env(safe-area-inset-top, 0));
          }

          .top-app-bar {
            height: 80px;
          }

          .app-title {
            font-size: 1.5rem;
          }

          .md-card-header {
            padding: 24px 24px 12px 24px;
          }

          .md-card-content {
            padding: 12px 24px 24px 24px;
          }

          .md-card-title {
            font-size: 1.25rem;
          }

          .data-value {
            font-size: 1.4rem;
          }

          .condition-group {
            padding: 20px 12px;
          }

          .conditions {
            gap: 16px;
          }

          .md-button {
            padding: 0 28px;
            min-height: 44px;
            font-size: 1rem;
          }
        }

        @media (min-width: 768px) {
          .main-container {
            gap: 24px;
          }

          .md-card {
            max-width: 600px;
          }
        }
    </style>
</head>

<body>
<!-- Top App Bar -->
<div class="top-app-bar">
    <h1 class="app-title">RSU1 SNOW CALL</h1>
</div>

<!-- Main Content -->
<div class="main-container">
    <!-- Date Display -->
    <div id="dateDisplay" class="date-display"></div>

    <!-- Calculate Button -->
    <button id="calculateButton" class="md-button md-button-filled">
        <span id="buttonText" class="md-button-text">Calculate Snow Day Chance</span>
        <span id="loadingSpinner" class="loading-spinner" style="display: none;"></span>
    </button>

    <!-- Weather Data Card -->
    <div id="weatherData" class="md-card">
        <div class="md-card-header">
            <h2 class="md-card-title">Current Conditions</h2>
        </div>
        <div class="md-card-content">
            <div class="conditions">
                <div class="condition-group">
                    <span class="material-symbols-rounded">device_thermostat</span>
                    <span class="data-value" id="temperature"></span>
                    <span class="condition-label">Expected Temp</span>
                </div>
                <div class="condition-group">
                    <span class="material-symbols-rounded">weather_snowy</span>
                    <span class="data-value" id="snow"></span>
                    <span class="condition-label">Expected Snow</span>
                </div>
                <div class="condition-group">
                    <span class="material-symbols-rounded">history</span>
                    <span class="data-value" id="prevSnow"></span>
                    <span class="condition-label">Previous Snow</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Prediction Card -->
    <div id="prediction" class="md-card">
        <div class="md-card-header">
            <h2 class="md-card-title">Snow Day Prediction</h2>
        </div>
        <div class="md-card-content">
            <p id="predictionText">Click "Calculate" to see your snow day prediction.</p>
        </div>
    </div>

    <!-- Bottom Section -->
    <div id="bottomSection" class="bottom-section">
        <img src="https://www.pressherald.com/wp-content/uploads/sites/4/2011/04/m-bath-rsu1-superintendent-patrick-manuel.jpg" alt="Patrick Manuel" class="avatar">
        <p class="footer-message">Please, Patrick! We need a break!</p>
    </div>

    <!-- Snowflakes -->
    <div id="snowflakes" class="snowflakes" aria-hidden="true"></div>

    <!-- Settings FAB -->
    <button id="settingsButton" class="fab">
        <span class="material-symbols-rounded">settings</span>
    </button>

    <!-- Bottom Sheet Overlay -->
    <div id="settingsOverlay" class="sheet-overlay"></div>

    <!-- Settings Bottom Sheet -->
    <div id="settingsSheet" class="bottom-sheet">
        <div class="sheet-header">
            <h2 class="sheet-title">Settings</h2>
            <button class="close-button" id="closeSettings">Done</button>
        </div>

        <div class="settings-section">
            <div class="settings-section-header">Appearance</div>
            <div class="settings-item" id="darkModeItem">
                <div class="settings-item-title">Dark Theme</div>
                <div class="settings-item-right">
                    <label class="md-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="switch-track"></span>
                    </label>
                </div>
            </div>
            <div class="settings-item" id="materialThemingItem">
                <div class="settings-item-title">Material You Theming</div>
                <div class="settings-item-right">
                    <label class="md-switch">
                        <input type="checkbox" id="materialThemingToggle" checked>
                        <span class="switch-track"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-header">Share</div>
            <div class="settings-item">
                <div class="settings-item-title">Share Snow Day Calculator</div>
                <div class="settings-item-right">
                    <button class="share-button" id="shareButton">
                        <span class="material-symbols-rounded">share</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-header">About</div>
            <div class="settings-item">
                <div class="settings-item-title">Privacy Policy</div>
                <div class="settings-item-right">
                    <a href="https://declan-wright.github.io/snowday-privacy-policy/" class="share-button">
                        <span class="material-symbols-outlined" style="font-size: 15px; margin-bottom: 0; font-variation-settings: 'FILL' 0;">open_in_new</span>
                    </a>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-title">Version</div>
                <div class="settings-item-right">
                    <span class="settings-version">1.0.0</span>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-title">Bundle ID</div>
                <div class="settings-item-right">
                    <span class="settings-bundle">com.snowdaycalculator</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Material Components Web JavaScript -->
<script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"></script>
<script>
    /*----------------------------------------------------
      Material You Integration & Theme Management
    ----------------------------------------------------*/
    // Helper function to handle Android color integration
    function initializeTheme() {
        // Check if the Android JS bridge is available
        if (typeof Android !== 'undefined' && Android.isDarkMode) {
            const isDarkMode = Android.isDarkMode();
            if (isDarkMode) {
                document.body.setAttribute('data-theme', 'dark');
                if (darkModeToggle) darkModeToggle.checked = true;
            }
        } else {
            // Fallback to saved preference
            const savedDarkMode = localStorage.getItem("darkMode") === "true";
            if (savedDarkMode) {
                document.body.setAttribute('data-theme', 'dark');
                if (darkModeToggle) darkModeToggle.checked = true;
            }
        }

        // Check if material theming should be enabled
        const savedMaterialTheming = localStorage.getItem("materialTheming") !== "false"; // Default to true
        if (!savedMaterialTheming) {
            document.body.setAttribute('data-material-theming', 'off');
            if (materialThemingToggle) materialThemingToggle.checked = false;
        } else if (materialThemingToggle) {
            materialThemingToggle.checked = true;
        }

        // Try to get system colors if available
        if (typeof Android !== 'undefined' && Android.getSystemColors) {
            try {
                const colorJson = Android.getSystemColors();
                if (colorJson) {
                    const colors = JSON.parse(colorJson);
                    applySystemColors(colors);
                }
            } catch (e) {
                console.error('Error applying system colors during initialization:', e);
            }
        }
    }

    // Function to convert hex color to RGB components
    function hexToRgb(hex) {
        if (!hex) return { r: 0, g: 0, b: 0 };

        // Remove # if present
        hex = hex.replace(/^#/, '');

        // Parse hex string to RGB
        let r, g, b;
        if (hex.length === 3) {
            // Short notation like #FFF
            r = parseInt(hex.charAt(0) + hex.charAt(0), 16);
            g = parseInt(hex.charAt(1) + hex.charAt(1), 16);
            b = parseInt(hex.charAt(2) + hex.charAt(2), 16);
        } else if (hex.length === 6) {
            // Standard notation like #FFFFFF
            r = parseInt(hex.substring(0, 2), 16);
            g = parseInt(hex.substring(2, 4), 16);
            b = parseInt(hex.substring(4, 6), 16);
        } else {
            console.error("Invalid hex color format:", hex);
            return { r: 0, g: 0, b: 0 };
        }

        return { r, g, b };
    }

    // Function to apply system colors to CSS variables
    function applySystemColors(colors) {
        console.log('Applying system colors:', colors);

        if (!colors) {
            console.error('No colors provided to applySystemColors');
            return;
        }

        // Check if Material Theming is disabled
        if (document.body.getAttribute('data-material-theming') === 'off') {
            console.log('Material Theming is disabled, not applying system colors');
            return;
        }

        // Apply Material You dynamic colors
        const root = document.documentElement;

        // Primary colors
        if (colors.primary) {
            console.log('Setting primary color to:', colors.primary);
            root.style.setProperty('--md-sys-color-primary', colors.primary);
        }

        if (colors.onPrimary) root.style.setProperty('--md-sys-color-on-primary', colors.onPrimary);
        if (colors.primaryContainer) root.style.setProperty('--md-sys-color-primary-container', colors.primaryContainer);
        if (colors.onPrimaryContainer) root.style.setProperty('--md-sys-color-on-primary-container', colors.onPrimaryContainer);

        // Secondary colors (use primary if secondary not provided)
        if (colors.secondary) {
            root.style.setProperty('--md-sys-color-secondary', colors.secondary);
        } else if (colors.primary) {
            root.style.setProperty('--md-sys-color-secondary', colors.primary);
        }

        if (colors.onSecondary) {
            root.style.setProperty('--md-sys-color-on-secondary', colors.onSecondary);
        } else if (colors.onPrimary) {
            root.style.setProperty('--md-sys-color-on-secondary', colors.onPrimary);
        }

        if (colors.secondaryContainer) {
            root.style.setProperty('--md-sys-color-secondary-container', colors.secondaryContainer);
        } else if (colors.primaryContainer) {
            root.style.setProperty('--md-sys-color-secondary-container', colors.primaryContainer);
        }

        if (colors.onSecondaryContainer) {
            root.style.setProperty('--md-sys-color-on-secondary-container', colors.onSecondaryContainer);
        } else if (colors.onPrimaryContainer) {
            root.style.setProperty('--md-sys-color-on-secondary-container', colors.onPrimaryContainer);
        }

        // Tertiary colors
        if (colors.tertiary) root.style.setProperty('--md-sys-color-tertiary', colors.tertiary);
        if (colors.onTertiary) root.style.setProperty('--md-sys-color-on-tertiary', colors.onTertiary);
        if (colors.tertiaryContainer) {
            root.style.setProperty('--md-sys-color-tertiary-container', colors.tertiaryContainer);
        } else if (colors.tertiary) {
            // If tertiaryContainer isn't available, derive it from tertiary
            const rgb = hexToRgb(colors.tertiary);
            const lighterColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
            root.style.setProperty('--md-sys-color-tertiary-container', lighterColor);
        }

        if (colors.onTertiaryContainer) {
            root.style.setProperty('--md-sys-color-on-tertiary-container', colors.onTertiaryContainer);
        } else if (colors.onTertiary) {
            root.style.setProperty('--md-sys-color-on-tertiary-container', colors.onTertiary);
        }

        // Surface colors
        if (colors.surface) root.style.setProperty('--md-sys-color-surface', colors.surface);
        if (colors.onSurface) root.style.setProperty('--md-sys-color-on-surface', colors.onSurface);
        if (colors.surfaceVariant) root.style.setProperty('--md-sys-color-surface-variant', colors.surfaceVariant);
        if (colors.onSurfaceVariant) root.style.setProperty('--md-sys-color-on-surface-variant', colors.onSurfaceVariant);

        // Background colors (typically same as surface)
        if (colors.surface) root.style.setProperty('--md-sys-color-background', colors.surface);
        if (colors.onSurface) root.style.setProperty('--md-sys-color-on-background', colors.onSurface);

        // Surface container
        if (colors.surfaceContainer) {
            root.style.setProperty('--md-sys-color-surface-container', colors.surfaceContainer);
        } else if (colors.surface) {
            root.style.setProperty('--md-sys-color-surface-container', colors.surface);
        }

        // Other colors
        if (colors.outline) root.style.setProperty('--md-sys-color-outline', colors.outline);
        if (colors.outlineVariant) {
            root.style.setProperty('--md-sys-color-outline-variant', colors.outlineVariant);
        } else if (colors.outline) {
            // Derive outlineVariant from outline if not provided
            const rgb = hexToRgb(colors.outline);
            const lighterColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
            root.style.setProperty('--md-sys-color-outline-variant', lighterColor);
        }

        // Status bar background - make it semi-transparent
        const statusBarColor = colors.surface || (document.body.getAttribute('data-theme') === 'dark' ? '#1f1b16' : '#fffbff');
        const rgbStatus = hexToRgb(statusBarColor);
        root.style.setProperty('--md-sys-color-status-bar', `rgba(${rgbStatus.r}, ${rgbStatus.g}, ${rgbStatus.b}, 0.95)`);

        // Update RGB version of primary for ripple effects
        if (colors.primary) {
            const primaryRgb = hexToRgb(colors.primary);
            if (primaryRgb) {
                root.style.setProperty('--md-sys-color-primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
            }
        }

        console.log('System colors applied successfully');

        // Force a subtle redraw to ensure colors apply
        document.body.style.opacity = 0.99;
        setTimeout(() => {
            document.body.style.opacity = 1;
        }, 50);

        // Update UI elements visibility now that colors are applied
        setTimeout(() => {
            // Make UI elements visible now that colors are applied
            const cards = document.querySelectorAll('.md-card');
            cards.forEach(card => card.classList.add('show'));

            const dateDisplay = document.getElementById('dateDisplay');
            if (dateDisplay) dateDisplay.classList.add('show');
        }, 300);
    }

    // Make the applySystemColors function globally available
    window.applySystemColors = applySystemColors;

    /*----------------------------------------------------
      Patch fetch for better error reporting
    ----------------------------------------------------*/
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      console.log('Fetch request to:', args[0]);
      return originalFetch(...args)
        .then(response => {
          console.log('Fetch response status:', response.status);
          if (!response.ok) {
            console.error('Fetch error:', response.status, response.statusText);
          }
          return response;
        })
        .catch(error => {
          console.error('Fetch catch error:', error);
          // If Android interface exists, show error
          if (typeof Android !== 'undefined') {
            Android.showToast('API Error: ' + error.message);
          }
          throw error;
        });
    };

    /*----------------------------------------------------
      Global Error Handler
    ----------------------------------------------------*/
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Global error:', message, 'at', source, lineno, colno);
      // If Android interface exists, show error
      if (typeof Android !== 'undefined') {
        Android.showToast('JavaScript Error: ' + message);
      }
      return false;
    };

    /*----------------------------------------------------
      Network Connectivity Check
    ----------------------------------------------------*/
    function checkNetwork() {
      console.log('Checking network connectivity...');
      const testUrl = 'https://api.weather.gov/points/43.915,-69.837222';
      return fetch(testUrl, {
        method: 'HEAD',
        headers: { "User-Agent": "SnowDayCalculator/1.0 (snowdaycalculator@protonmail.com)" }
      })
      .then(response => {
        console.log('Network check response:', response.status);
        return response.ok;
      })
      .catch(error => {
        console.error('Network check failed:', error);
        if (typeof Android !== 'undefined') {
          Android.showToast('Network check failed: ' + error.message);
        }
        return false;
      });
    }

    /*----------------------------------------------------
      Snow Day Calculation Model
    ----------------------------------------------------*/
    // Model weights from Snowday Model F2 0.912.json
    const weights = {
      W1: [
        [0.41663657747586713, 0.5256001778225754, 2.1566107829165384],
        [-0.7556965015080414, -1.7543907837051484, 0.24571689278812842],
        [0.46303925095762705, -0.16221288582505167, -0.2893163450287195],
        [0.8132460484584749, -0.7063328189834551, -1.857206041364893],
        [0.8493428004272436, -0.08194846637293386, 0.2881652505650596],
        [0.8929670284270083, -0.24857252350997114, -0.38856121748190847],
        [0.013065484479550698, -1.5157351152575074, 0.45289147387516354],
        [0.8079531247713924, 1.2261087544157487, 0.4851562113095939]
      ],
      b1: [
        [0.003005140757832803],
        [-0.02749235861910012],
        [0.07267728745945415],
        [-0.03737230554086685],
        [0.038856390481357764],
        [-0.0388372356576684],
        [-0.03052688095705094],
        [-0.008072900817557165]
      ],
      W2: [
        [0.09751955264289433, -1.0467263585083966, 0.9994834833401101, -0.4255949608721677, 0.5736469822120318, -0.4420086549415937, -0.6605809275033416, 0.014654692656513325]
      ],
      b2: [[0.11315243401435356]]
    };

    const calibration = {
      temperature: 1.6536551017280212,
      optimal_threshold: 0.444443502330337
    };

    /*----------------------------------------------------
      Initialize Elements
    ----------------------------------------------------*/
    // Get UI elements
    const calculateButton = document.getElementById("calculateButton");
    const buttonText = document.getElementById("buttonText");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const temperatureDisplay = document.getElementById("temperature");
    const snowDisplay = document.getElementById("snow");
    const prevSnowDisplay = document.getElementById("prevSnow");
    const predictionText = document.getElementById("predictionText");
    const dateDisplay = document.getElementById("dateDisplay");
    const weatherDataSection = document.getElementById("weatherData");
    const predictionSection = document.getElementById("prediction");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const darkModeItem = document.getElementById("darkModeItem");
    const materialThemingToggle = document.getElementById("materialThemingToggle");
    const settingsButton = document.getElementById("settingsButton");
    const settingsSheet = document.getElementById("settingsSheet");
    const settingsOverlay = document.getElementById("settingsOverlay");
    const closeSettings = document.getElementById("closeSettings");
    const shareButton = document.getElementById("shareButton");

    // Set coordinates for Bath, ME
    const LAT = 43.915;
    const LON = -69.837222;

    // Initialize date display
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateDisplay.innerHTML = `Calculating for <strong>${formatDate(tomorrow)}</strong>`;

    // Create snowflakes animation
    createSnowflakes();

    // Initialize theme and check for colors
    initializeTheme();

    /*----------------------------------------------------
      Add Event Listeners
    ----------------------------------------------------*/
    // Main functionality
    calculateButton.addEventListener("click", handleCalculateClick);
    darkModeToggle.addEventListener("change", toggleDarkMode);
    darkModeItem.addEventListener("click", toggleDarkModeFromItem);
    materialThemingToggle.addEventListener("change", toggleMaterialTheming);
    document.getElementById("materialThemingItem").addEventListener("click", toggleMaterialThemingFromItem);
    settingsButton.addEventListener("click", openSettings);
    closeSettings.addEventListener("click", closeSettingsSheet);
    settingsOverlay.addEventListener("click", closeSettingsSheet);
    shareButton.addEventListener("click", shareApp);

    // Add network check to calculate button
    const calcButton = document.getElementById('calculateButton');
    if (calcButton) {
      const originalClickHandler = calcButton.onclick;
      calcButton.onclick = function(event) {
        console.log('Calculate button clicked');
        // First check network
        checkNetwork().then(isConnected => {
          if (isConnected) {
            console.log('Network is available, proceeding with calculation');
            if (originalClickHandler) {
              originalClickHandler.call(this, event);
            } else {
              handleCalculateClick();
            }
          } else {
            console.error('Network is not available');
            if (typeof Android !== 'undefined') {
              Android.showToast('Unable to connect to weather API. Please check your connection.');
            } else {
              alert('Unable to connect to weather API. Please check your connection.');
            }
          }
        });
        return false; // Prevent default
      };
    }

    // Add swipe down to close settings
    let touchStartY = 0;
    let touchEndY = 0;

    settingsSheet.addEventListener("touchstart", function(event) {
      touchStartY = event.touches[0].clientY;
    }, false);

    settingsSheet.addEventListener("touchmove", function(event) {
      touchEndY = event.touches[0].clientY;

      // If swiping down
      if (touchEndY - touchStartY > 50) {
        closeSettingsSheet();
      }
    }, false);

    // Add ripple effect for buttons
    function createRipple(event) {
      const button = event.currentTarget;

      // Skip if the element already has an active ripple
      if (button.querySelector('.ripple')) return;

      const circle = document.createElement('span');
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      const radius = diameter / 2;

      // Get position
      let rect = button.getBoundingClientRect();
      let x, y;

      if (event.type === 'touchstart') {
        x = event.touches[0].clientX - rect.left;
        y = event.touches[0].clientY - rect.top;
      } else {
        x = event.clientX - rect.left;
        y = event.clientY - rect.top;
      }

      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${x - radius}px`;
      circle.style.top = `${y - radius}px`;
      circle.classList.add('ripple');

      // Style the ripple
      circle.style.position = 'absolute';
      circle.style.borderRadius = '50%';
      circle.style.transform = 'scale(0)';
      circle.style.animation = 'ripple 0.6s linear';
      circle.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
      circle.style.pointerEvents = 'none';

      // Add the ripple and handle removal
      button.appendChild(circle);

      setTimeout(() => {
        if (circle) {
          circle.remove();
        }
      }, 600);
    }

    // Add ripple to interactive elements, but not to FAB
    document.querySelectorAll('.md-button, .settings-item, .close-button').forEach(el => {
      el.addEventListener('touchstart', createRipple, {passive: true});
      el.addEventListener('mousedown', createRipple);
    });

    // Add the Material You update handler for communication with Android
    window.updateThemeColors = function() {
        if (typeof Android !== 'undefined' && Android.getSystemColors) {
            try {
                const colorJson = Android.getSystemColors();
                if (colorJson) {
                    const colors = JSON.parse(colorJson);
                    applySystemColors(colors);
                }
            } catch (e) {
                console.error('Error in updateThemeColors:', e);
            }
        }
    };

    // Setup color system on document ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Document ready, setting up color system');

        // Add keyframes for ripple animation if not already present
        if (!document.querySelector('#ripple-animation')) {
            const style = document.createElement('style');
            style.id = 'ripple-animation';
            style.textContent = `
                @keyframes ripple {
                    to {
                    transform: scale(4);
                    opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Check if colors were passed while the page was still loading
        if (window.systemColorsReady && window.systemColors) {
            console.log('Found cached system colors, applying now');
            applySystemColors(window.systemColors);
            window.systemColorsReady = false;
        }

        // Show UI elements with animation after initial setup
        setTimeout(() => {
            dateDisplay.classList.add("show");
        }, 200);
    });

    /*----------------------------------------------------
      Helper Functions
    ----------------------------------------------------*/
    function sigmoid(z) {
      return 1 / (1 + Math.exp(-z));
    }

    function relu(z) {
      return Math.max(0, z);
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat("en-US", { weekday: "long" }).format(date);
    }

    function calculateMLPSnowDayProbability(snowfall, prevSnow, minTemp) {
      const X_input = [[snowfall], [prevSnow], [minTemp]];
      let a1 = [];

      for (let i = 0; i < weights.W1.length; i++) {
        let sum = 0;
        for (let j = 0; j < weights.W1[0].length; j++) {
          sum += weights.W1[i][j] * X_input[j][0];
        }
        a1.push([relu(sum + weights.b1[i][0])]);
      }

      let y_hat_logit = 0;
      for (let i = 0; i < weights.W2[0].length; i++) {
        y_hat_logit += weights.W2[0][i] * a1[i][0];
      }
      y_hat_logit += weights.b2[0][0];

      let raw_prob = sigmoid(y_hat_logit);
      const logit = Math.log(raw_prob / (1 - raw_prob));
      const calibrated_prob = sigmoid(logit / calibration.temperature);

      return calibrated_prob;
    }

    function calculateExpectedSnowfall(periods) {
      let snowfallTotal = 0;

      periods.forEach(period => {
        if (period.temperature <= 32 && period.probabilityOfPrecipitation.value > 0) {
          let tempFactor = (32 - period.temperature) / 32;
          let snowAccumulation = (period.probabilityOfPrecipitation.value / 100) * 0.2 * (1 + tempFactor);
          snowfallTotal += snowAccumulation;
        }
      });

      return snowfallTotal;
    }

    function getDescriptiveText(probability) {
      const prob = parseFloat(probability);

      if (prob >= 80) {
        return "High likelihood of a snow day tomorrow! Get ready to sleep in!";
      } else if (prob >= 70) {
        return "There's a decent chance! Keep an eye on those weather reports!";
      } else if (prob >= 25) {
        return "Don't get your hopes up too high, but there's a small chance!";
      } else {
        return "Sorry, but you'll be going to school tomorrow. Set your alarm.";
      }
    }

    function createSnowflakes() {
      const snowContainer = document.getElementById("snowflakes");
      const snowflakeCount = Math.min(window.innerWidth / 8, 60); // Limit based on screen width

      for (let i = 0; i < snowflakeCount; i++) {
        const snowflake = document.createElement("div");
        snowflake.classList.add("snowflake");
        snowflake.style.left = `${Math.random() * 100}vw`;

        const duration = Math.random() * 8 + 8; // Slower, more gentle falling
        snowflake.style.animationDuration = `${duration}s`;
        snowflake.style.animationDelay = `-${Math.random() * duration}s`;

        const size = Math.random() * 4 + 2;
        snowflake.style.width = `${size}px`;
        snowflake.style.height = `${size}px`;

        // Add slight blur for more depth
        snowflake.style.filter = `blur(${Math.random()}px)`;

        snowContainer.appendChild(snowflake);
      }
    }

    function toggleDarkMode() {
      const isDarkMode = darkModeToggle.checked;

      if (isDarkMode) {
        document.body.setAttribute('data-theme', 'dark');
      } else {
        document.body.removeAttribute('data-theme');
      }

      localStorage.setItem("darkMode", isDarkMode);

      // Notify Android of theme change if the bridge is available
      if (typeof Android !== 'undefined' && Android.setDarkMode) {
        Android.setDarkMode(isDarkMode);
      }

      // Ask for updated Material You colors that match the current theme
      if (document.body.getAttribute('data-material-theming') !== 'off' &&
          typeof Android !== 'undefined' && Android.getSystemColors) {
        try {
            const colorJson = Android.getSystemColors();
            if (colorJson) {
                const colors = JSON.parse(colorJson);
                applySystemColors(colors);
            }
        } catch (e) {
            console.error('Error updating colors after theme change:', e);
        }
      }

      // Add haptic feedback
      if (typeof Android !== 'undefined' && Android.vibrate) {
        Android.vibrate(15);
      } else if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(15);
      }
    }

    function toggleDarkModeFromItem(event) {
      // If not clicking directly on the toggle, toggle it programmatically
      if (!event.target.closest('.md-switch')) {
        darkModeToggle.checked = !darkModeToggle.checked;
        toggleDarkMode();
      }
    }

    function toggleMaterialTheming() {
      const isMaterialThemingOn = materialThemingToggle.checked;

      if (isMaterialThemingOn) {
        document.body.removeAttribute('data-material-theming');

        // If Android interface exists, get system colors and apply them
        if (typeof Android !== 'undefined' && Android.getSystemColors) {
            try {
                console.log('Getting system colors after enabling Material Theming');
                const colorJson = Android.getSystemColors();
                if (colorJson) {
                    const colors = JSON.parse(colorJson);
                    applySystemColors(colors);
                }
            } catch (e) {
                console.error('Error applying system colors:', e);
            }
        }
      } else {
        document.body.setAttribute('data-material-theming', 'off');
        console.log('Material theming turned off');
      }

      localStorage.setItem("materialTheming", isMaterialThemingOn);

      // Add haptic feedback
      if (typeof Android !== 'undefined' && Android.vibrate) {
        Android.vibrate(15);
      } else if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(15);
      }
    }

    function toggleMaterialThemingFromItem(event) {
      // If not clicking directly on the toggle, toggle it programmatically
      if (!event.target.closest('.md-switch')) {
        materialThemingToggle.checked = !materialThemingToggle.checked;
        toggleMaterialTheming();
      }
    }

    function openSettings() {
      settingsOverlay.classList.add("active");
      settingsSheet.classList.add("active");

      // Add haptic feedback
      if (typeof Android !== 'undefined' && Android.vibrate) {
        Android.vibrate([10, 30, 10]);
      } else if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate([10, 30, 10]);
      }
    }

    function closeSettingsSheet() {
      settingsOverlay.classList.remove("active");
      settingsSheet.classList.remove("active");

      // Add haptic feedback
      if (typeof Android !== 'undefined' && Android.vibrate) {
        Android.vibrate(10);
      } else if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(10);
      }
    }

    function shareApp() {
      // Check if running in Android WebView
      if (typeof Android !== 'undefined' && Android.shareContent) {
        try {
          Android.shareContent(
            'RSU1 Snow Day Calculator',
            'Check out this Snow Day Calculator for RSU1 schools!',
            window.location.href
          );
        } catch (e) {
          console.error('Error sharing:', e);
        }
      } else if (navigator.share) {
        navigator.share({
          title: 'RSU1 Snow Day Calculator',
          text: 'Check out this Snow Day Calculator for RSU1 schools!',
          url: window.location.href
        })
        .then(() => console.log('Share successful'))
        .catch((error) => console.log('Error sharing:', error));
      } else {
        alert('Web Share API not supported in your browser. Try copying the URL manually.');
      }
    }

    function showLoading() {
      buttonText.textContent = "Analyzing Weather";
      loadingSpinner.style.display = "inline-block";
      calculateButton.classList.add("analyzing");
      weatherDataSection.classList.remove("show");
      predictionSection.classList.remove("show");
    }

    function hideLoading() {
      buttonText.textContent = "Calculate Snow Day Chance";
      loadingSpinner.style.display = "none";
      calculateButton.classList.remove("analyzing");
    }

    async function handleCalculateClick() {
      showLoading();

      // Add slight delay for visual effect
      setTimeout(() => {
        fetchWeatherData();
      }, 1000);
    }

    async function fetchWeatherData() {
      try {
        const pointResponse = await fetch(`https://api.weather.gov/points/${LAT},${LON}`, {
          headers: { "User-Agent": "SnowDayCalculator/1.0 (snowdaycalculator@protonmail.com)" }
        });

        if (!pointResponse.ok) {
          throw new Error("Weather API request failed");
        }

        const pointData = await pointResponse.json();

        const [forecastResponse, hourlyResponse] = await Promise.all([
          fetch(pointData.properties.forecast, {
            headers: { "User-Agent": "SnowDayCalculator/1.0 (snowdaycalculator@protonmail.com)" }
          }),
          fetch(pointData.properties.forecastHourly, {
            headers: { "User-Agent": "SnowDayCalculator/1.0 (snowdaycalculator@protonmail.com)" }
          })
        ]);

        if (!hourlyResponse.ok) {
          throw new Error("Hourly forecast API request failed");
        }

        const hourlyData = await hourlyResponse.json();

        // Filter tomorrow's hourly forecast
        const tomorrowHourly = hourlyData.properties.periods.filter(period => {
          const periodDate = new Date(period.startTime);
          return periodDate.getDate() === tomorrow.getDate();
        });

        const minTemp = Math.min(...tomorrowHourly.map(period => period.temperature));
        const snowfall = calculateExpectedSnowfall(tomorrowHourly);

        // Calculate previous day's snow
        const now = new Date();
        const todayRemaining = hourlyData.properties.periods.filter(period => {
          const periodDate = new Date(period.startTime);
          return periodDate.getDate() === now.getDate() && periodDate.getHours() >= now.getHours();
        });

        const prevSnow = todayRemaining.reduce((acc, period) => {
          if (period.temperature <= 32 && period.probabilityOfPrecipitation.value > 0) {
            return acc + (period.probabilityOfPrecipitation.value / 100) * 0.1;
          }
          return acc;
        }, 0);

        // Update UI with weather data
        temperatureDisplay.textContent = `${minTemp}°F`;
        snowDisplay.textContent = `${snowfall.toFixed(1)}"`;
        prevSnowDisplay.textContent = `${prevSnow.toFixed(1)}"`;

        // Calculate snow day probability
        let mlpProbability;
        const threshold = 0.2;

        if (snowfall < threshold && prevSnow < threshold) {
          mlpProbability = 0;
        } else {
          mlpProbability = calculateMLPSnowDayProbability(snowfall, prevSnow, minTemp);
        }

        // Convert raw probability to display probability
        let displayedProbability;
        if (mlpProbability < calibration.optimal_threshold) {
          displayedProbability = (mlpProbability / calibration.optimal_threshold) * 70;
        } else {
          displayedProbability = 70 + ((mlpProbability - calibration.optimal_threshold) / (1 - calibration.optimal_threshold)) * 30;
        }

        const probabilityPercentage = displayedProbability.toFixed(1);
        const prediction = mlpProbability >= calibration.optimal_threshold ? "Yes" : "No";

        // Show weather data section with animation
        weatherDataSection.classList.add("show");

        // Update prediction section with Material Design layout
        predictionText.innerHTML = `
          <div class="gauge-container">
            <div class="gauge-value">${probabilityPercentage}%</div>
            <div class="gauge">
              <div class="gauge-fill" id="gaugeFill"></div>
            </div>
          </div>
          <div class="prediction-result">
            <div class="prediction-header">Snow Day Predicted: <strong>${prediction}</strong></div>
            <div class="prediction-description">${getDescriptiveText(probabilityPercentage)}</div>
          </div>
        `;

        // Show prediction section with animation
        predictionSection.classList.add("show");

        // Animate gauge fill after a small delay
        setTimeout(() => {
          document.getElementById("gaugeFill").style.width = probabilityPercentage + "%";
        }, 300);

      } catch (error) {
        console.error("Error fetching weather data:", error);

        // Show error in prediction section with Material Design
        predictionText.innerHTML = `
          <div style="text-align: center; padding: 24px;">
            <span class="material-symbols-rounded" style="font-size: 48px; color: var(--md-sys-color-error); margin-bottom: 16px;">error</span>
            <p style="margin-bottom: 12px; font-weight: 500; color: var(--md-sys-color-on-surface);">Unable to load weather data</p>
            <p style="color: var(--md-sys-color-on-surface-variant);">Please check your connection and try again.</p>
          </div>
        `;

        predictionSection.classList.add("show");
      } finally {
        hideLoading();
      }
    }

    // If system colors were set before page loaded, apply them now
    if (window.systemColorsReady && window.systemColors) {
        console.log("Found system colors set before script loaded, applying now");
        setTimeout(() => {
            applySystemColors(window.systemColors);
            window.systemColorsReady = false;
        }, 100);
    }
</script>
</body>
</html>